# 13. 短いコードを書く

プログラマの能力は書いたコードの量で決まるわけではない

より多くのコードを書けば、より多くのテストや保守などに時間が必要となる

ライブラリの再利用や機能の削除はコードを簡潔に維持し、それらの時間を節約することを目的としている

**最も読みやすいコードは何も書かれていないコード**


## 13-1. その機能の実装について悩まないで -- きっと必要ないから

プロジェクトに欠かせない機能を過剰に見積もりがち

過剰な見積もりによる多くの機能は以下のような結果をもたらす。

* 完成しない
* まったく使われない
* アプリケーションを複雑にする

実装にかかる労力を過小評価したり、
プロトタイプの実装にかかる時間を楽観的に見積もったり、
将来の運用や保守、文書化などの負担を忘れないようにする。

## 13-2. 質問と要求の分割

すべてのプログラムが高速に 100% 正しく、あらゆる入力をうまく処理する必要はない。

要求から問題をさらに簡単にできることもあり、それができればコードも少なくて済む。

「任意のユーザの緯度経度に対して、最も近い店舗を検索する。」という要求を
100% 正しく実装するには以下のような考慮が必要となる。

* 日付変更線をまたいでいるときの処理
* 北極や南極に近いときの処理
* 「マイルあたりの経度」対応した地球の曲率の調整

上記を真面目に処理すれば複雑なコードとなる。

もし、要求の対象がテキサス州にある30軒の店舗からの検索であれば、
テキサス州のような小さな範囲でこのような処理を考える必要がないという
判断ができる。要求から削除すればよい。

新しい要求は次のようになる。

テキサス州のユーザのために、テキサスで最も近くにある店舗を検索する。

この問題を解決することは簡単で、すべての店舗との距離を計算してしまえばよい。

## 13-3. コードを小さく保つ

ソフトウェアプロジェクトの初期ではソースファイルの数は少なく、見通しもよい。

変更もしやすく、関数やクラスをどこで定義しているかもすぐに思い出せる。

プロジェクトが進むとファイルやディレクトリが増えていく。

どの関数がどの関数を呼び出しているのかを調べるのに時間がかかるようになり、
バグを見つけるのもだんだん困難になっていく。

最終的に巨大になったプロジェクトは、すべてを把握している人は誰もいなくなる。
新しい機能を追加するのが苦痛になる。コードを扱うのが厄介になり楽しくなくなる。

これを回避するにはプロジェクトが成長しても
**コードをできるだけ小さく軽量に維持するしかない**

以下のような対策をとる必要がある。

* 汎用的な「ユーティリティ」コードを作って、重複コードを削除する
  * 10 章 無関係の下位問題を抽出する
* 未使用のコードや無用の機能を削除する
* プロジェクトをサブプロジェクトに分割する
* コードの「重量」を意識し、軽量で機敏にする

// ToDo: Screen Shot グラフ


## 13-4. 身近なライブラリに親しむ

既存のライブラリで問題を解決できることは多い。

ライブラリで可能なことを忘れていることも多い。

ライブラリの 機能を熟知して、実際に活用することが大切となる。

**標準ライブラリのすべての関数・モジュール・ 型の名前を 15 分かけて読んでみよう**

* C++ 標準テンプレートライブラリ(STL)
* Java の API
* Python の組み込みモジュール

すべてを覚える必要はなく、使えそうな直感が働いたときに調べられるようになればよい。

## 13-5. 例: コーディングするよりも Unix ツールボックスを使う

コマンドラインを使うと **「ホンモノのコード」を書かなくてもよい** 。

ウェブサーバのログをパースして調査するケースについて考えてみる。

```
1.2.3.4 example.com [24/Aug/2010:01:08:34] "GET /index.html HTTP/1.1" 200 ... 
2.3.4.5 example.com [24/Aug/2010:01:14:27] "GET /help?topic=8 HTTP/1.1" 500 ... 
3.4.5.6 example.com [24/Aug/2010:01:15:54] "GET /favicon.ico HTTP/1.1" 404 ... 
...
```

汎化した表現は以下のようになる。

`browser-IP host [date] "GET /url-path HTTP/1.1" HTTP-response-code ...`

この形式から `4xx` や `5xx` のレスポンスコードを返している `url-path` を
見つけるプログラムを C++ や Java (あるいは Python) のような言語で
書くと軽く20行は越えてしまう。

Unix では以下のコマンドで解決できる。

`cat access.log | awk '{ print $5 " " $7 }' | egrep "[45]..$" ¥ | sort | uniq -c | sort -nr`

以下のような出力が得られる。

```
95 /favicon.ico 404
13 /help?topic=8 500
11 /login 403
...
```

`< カウント > < パス > <HTTP レスポンスコード >` が件数順に並んでいる。

これから原因を特定することは簡単だろう。

## 13-6. まとめ

新しいコードにはテストや文書、保守が必要となる。

コードが増えれば開発は重くなり、問題の解決も難しくなる。

新しいコードを増やさないようにするには以下のようなことに注意する。

* 不必要な機能をプロダクトから削除する
* 過剰な機能は持たせない
* 最も簡単に問題を解決できるような要求を考える
* 標準ライブラリに慣れ親しんでおく
