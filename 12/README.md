# 12. コードに思いを込める

複雑な考えについて、相手の背景を考慮せずにはじめから細部まで伝えることは難しい

より明確で簡単なコードを記述することでプログラムの動作を説明するべき

本章ではコードをより明確にする以下のような手順を使う

1. コードの動作を簡単な言葉で同僚にもわかるように説明
2. 説明のなかで使っているキーワードやフレーズに注目
3. 説明に合わせてコードを記述

## 12-1.ロジックを明確に説明する

以下のような特徴をもつ PHP のコードを用いた例で説明する

* セキュアページを扱うコードの最上位
* ユーザにページを閲覧する権限があるかを確認
* 権限がなければ、権限がないことをユーザに知らせるページに遷移

// ToDo: Screen Shot

このコードには大きなロジックツリーがあり、理解することが難しい

以下の手順で問題を解決する

* ロジックを単純化する
* ロジックを簡単な言葉で説明

ロジックの単純化と簡単な言葉による説明を行うと、権限があるのは以下のパターン

1. 管理者
2. 文書の所有者

上記の説明からの新しいコード

// ToDo: Screen Shot

* コードは小さくなった
* ロジックも単純になった
* 否定形がなくなった

if 文の中身がふたつも空だが、こちらのほうが理解しやすい

## 12-2. ライブラリを知る

ヒントが表示されるウェブサイトを例に扱う

```
ヒント: 過去のクエリを見るにはログインしてください。
```

ヒントはすべて HTML に隠された状態で存在している

```
<div id="tip-1" class="tip"> ヒント:過去のクエリを見るにはログインしてください。</div>
<div id="tip-2" class="tip"> ヒント:拡大するには画像をクリックしてください。</div>
...
```

jQuery を用いて次のヒントを閲覧する JavaScript のコードの記述が以下の通り

// ToDo: Screen Shot

動作には問題のないコードであるが、手順に沿ってコードを改善する

1. コードの動作を簡単な言葉で同僚にもわかるように説明
2. 説明のなかで使っているキーワードやフレーズに注目
3. 説明に合わせてコードを記述

* ロジックを単純化する
* ロジックを簡単な言葉で説明

簡単な説明にまとめると以下の説明となる

* いま見えているヒントを見つけて隠す
* 次のヒントを見つけて表示する
* ヒントがなくなったら、最初のヒントに戻る

上記の説明をもとに記述したコードは以下のようになる

// ToDo: Screen Shot

* コードは短くなった
* 数値の直接操作が不要になった
* 人間が考えているロジックに近いコードになった

jQuery の `.next` メソッドを知っていれば簡潔なコードが書ける

ライブラリがどのような機能を提供しているのかを知ることは
簡潔なコードを書くのに欠かせない

## 12-3. この手法を大きな問題に適用する

株式の購入を記録するシステムを例に大きな問題についての適用を考える

このシステムでは取引について次のようなデータを扱う

1. `time` -- 正確な購入日時
2. `ticker_symbol` -- 銘柄 ex. `GOOG`
3. `price` -- 価格 ex. `$600`
4. `number_of_shares` -- 株式数 ex. `100`

上記のデータはみっつのテーブルに格納されている

// ToDo: Screen Shot

適切にデータを取り扱うためには、みっつのテーブルを
(SQLの `JOIN` のように)結合するコードを書かなければならない

* すべての行が `time` でソートされている
* データが欠けている行も存在する
* すべてのテーブルの `time` が一致する行のみを検索

`time` が一致する行だけを検索する Python のコードは以下のようになる

// ToDo: Screen Shot

* 一致しない行をスキップするロジックが難しい
  * 行を抜かしていないか注意
  * イテレータを読み込みすぎていないか注意

「解決策を言葉で説明する」ことと「手法を再帰的に適用する」ことを
通してこのコードをもっと読みやすくする

### 解決策を言葉で説明する

簡単な言葉で説明することからはじめる

* みっつの行のイテレータを一度に読み込む
* 行の `time` が一致していなければ、一致するまで行を進める
* 一致した行を印字して、行を進める
* 一致する行がなくなるまでこれを繰り返す

とくに **一致するまで行を進める** という処理が複雑となっている

これを簡潔にするために `AdvanceToMatchingTime()` という関数にまとめる

// ToDo: Screen Shot

行を一致させるための複雑な箇所が隠蔽され、理解しやすくなった


### 手法を再帰的に適用する
`AdvanceToMatchingTime()` の責務に基づいて愚直に書いたコードは以下のようになる

// ToDo: Screen Shot

`AdvanceToMatchingTime()` にもいままでの改善と同じ手法を
適用するために簡単な説明に書き下す

* 現在の行の `time` を見て、一致していれば終了する
* 一致していなければ「遅れている」行を進める
* 行が一致するまで(あるいはイテレーションのいずれかが終了するまで)これを繰り返す

`stock_iter` などの問題の詳細に言及しないことでコードより簡単な説明となった

変数名をより簡潔で汎用的なものに改名できるということになる

上記の説明に合わせて書き換えたコードは以下のようになる

// ToDo: Screen Shot

コードが以前よりも簡潔になった

* アルゴリズムは単純になった
* 複雑な比較はほとんどなくなった
* データベースのカラム名を考えなくてもよくなった
  * `t1` のような短い名前の導入による


## 12-4. まとめ

本章ではプログラムのことを簡単な言葉で説明する技法について説明した。
説明することでよりコードが自然になる。
簡単な技法だがとても効果がある。

説明で使っている単語やフレーズをよく観察すれば分割する問題の単位が
どこにあるか把握することができ、下位問題に分割できる。

「簡単な言葉で説明する」手法はコードを書くこと以外にも役立つ。

たとえば、解こうとしている問題について声に出して説明するだけで、
解決策が見つかることさえある。
この技法は「ラバーダッキング」とも呼ばれている。

また、問題や設計をうまく言葉で説明できない場合は、何かを見落としているか、
詳細が明確になっていないということになる。

プログラムや自分の考えは言葉にすることで明確な形にできる。



